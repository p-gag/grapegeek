# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Common Commands

### Running the Application
```bash
# Generate a technical article for a grape variety
python main.py grape <variety_name> --type technical

# Generate and auto-publish a technical article to MkDocs site
python main.py grape <variety_name> --type technical --publish

# Generate winemaking stories for a grape variety  
python main.py grape <variety_name> --type story

# Sync all content to French site with smart change detection
python sync_french.py

# Dry run (show prompts without calling OpenAI)
python main.py grape <variety_name> --dry-run
python main.py region <region_name> --dry-run
```

### MkDocs Site Management
```bash
# Install MkDocs dependencies
pip install mkdocs-material mkdocs-git-revision-date-localized-plugin

# Test site locally
mkdocs serve

# Manual site build (GitHub Actions handles deployment automatically)
mkdocs build
```

### Dependencies
```bash
# Install dependencies using uv (preferred)
uv sync

# Or install with pip
pip install -e .
```

### Environment Setup
- Requires `OPENAI_API_KEY` environment variable (uses OpenAI Responses API with web_search tools)
- Uses `.env` file for environment variables

## Project Architecture

### Core Structure
This is an AI-powered content generation system for creating magazine-style articles about cold-climate grape varieties, focused on hybrid grapes in northeastern US and eastern Canada.

**Main Components:**
- `main.py`: CLI entry point with subcommands for grape articles and region research
- `src/grapegeek/base.py`: BaseGenerator class with shared OpenAI integration and file handling
- `src/grapegeek/grape_article_generator.py`: GrapeArticleGenerator for variety-specific content
- `src/grapegeek/region_researcher.py`: RegionResearcher for regional variety discovery

### Prompt System Architecture
The application uses a layered prompt system:

1. **General Prompts** (`prompts/general/`): System-wide instructions for tone, citation style
2. **Content-Type Prompts** (`prompts/grapes/`): 
   - `technical_prompt.md`: Comprehensive technical analysis template
   - `art_prompt.md`: Winemaking story and narrative template
3. **Entity Context** (`prompts/grapes/articles/`, `prompts/regions/`): 
   - YAML frontmatter files with variety/region-specific context
   - Prevents AI confusion by providing precise identification context

### OpenAI Integration
- Uses OpenAI Responses API with `gpt-5` model
- Includes `web_search` tool for real-time research and citation gathering
- All API calls go through `BaseGenerator.call_openai()` method
- Dry run mode shows full prompt structure and debug information without API calls

### Output Organization
- `output/articles/`: Generated English grape variety articles
  - Technical: `{variety_name}.md` 
  - Stories: `{variety_name}_winemaking_stories.md`
- `output/regions/`: Regional research results as `{region_name}_varieties.md`
- `output/fr/`: French translations of articles (generated by `french_generator.py`)
- `debug/`: Dry run outputs with `_debug.md` suffix

### Site Structure (MkDocs)
- `docs/`: English site content
  - `index.md`: English homepage
  - `about.md`: English about page  
  - `varieties/index.md`: English grape varieties section
  - `ai-usage.md`: AI transparency page
- `docs/fr/`: French site content
  - `index.md`: French homepage (Accueil)
  - `a-propos.md`: French about page (À propos)
  - `varietes/index.md`: French grape varieties section
  - `usage-ia.md`: AI transparency page (French)

### Variety Context System
Each grape variety can have a context file at `prompts/grapes/articles/{variety_name}.md` with YAML frontmatter:
```yaml
---
name: "Official Variety Name"
prompt: "Minimal context to avoid confusion with similarly named varieties"
---
```

### Region Context System  
Each region can have a context file at `prompts/regions/{region_name}.md` with YAML frontmatter:
```yaml
---
name: "Region Name"
summary: "Brief regional description"
known_varieties: "List of known varieties"
trade_association: "Association name"
trade_association_url: "URL"
---
```

### French Translation System
- `sync_french.py`: Smart French synchronization script with hash-based change detection
- Uses OpenAI Responses API with `gpt-5` model and Quebec French context
- Only translates files that have changed since last sync (tracked via YAML frontmatter hashes)
- Preserves technical terms, citations, and markdown formatting
- Handles both technical articles and site pages
- Automatic YAML frontmatter management for change tracking

## Development Notes

### Content Publishing Workflow
1. **Generate and publish**: Use `main.py grape <variety> --type technical --publish` to auto-generate and publish to MkDocs site
2. **Sync French content**: Run `python sync_french.py` to translate changed content to French site
3. **Deploy**: Commit changes → GitHub Actions automatically builds and deploys MkDocs site

**Auto-publish features:**
- Technical articles automatically copied to `docs/varieties/` with proper YAML frontmatter
- Varieties index page automatically updated with new entries
- Only technical articles auto-publish; stories remain manual workflow

### Site Deployment
- **Live site**: https://grapegeek.com (custom domain) and https://p-gag.github.io/grapegeek/
- **Auto-deployment**: GitHub Actions workflow builds MkDocs on every push to main branch
- **Bilingual navigation**: Material theme with language selector in top bar
- **Local testing**: Use `mkdocs serve` to preview changes before publishing

### File Handling Patterns
- All file operations use `pathlib.Path` 
- YAML frontmatter parsing handles missing files gracefully with defaults
- Output directories are created automatically
- Generated files in `output/` and `debug/` are git-ignored

### Error Handling
- OpenAI API errors are caught and returned as error strings
- Missing prompt files return empty strings rather than failing
- Dry run mode provides comprehensive debugging without API calls

### Code Organization
- Shared functionality is in `BaseGenerator` base class
- Generator classes inherit common file operations and OpenAI integration
- CLI uses argparse with subcommands for different content types
- French translation is separate standalone script (simpler than base class inheritance)