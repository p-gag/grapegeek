# ğŸŒ³ Family Tree Integration Plan

## ğŸ“‹ **Implementation Overview**
Port the existing `grape-tree-react/` React Flow family tree viewer into the main `grape-explorer-react` application, following the same architectural pattern established for the map integration.

## ğŸ¯ **Goals**
- **Preview + Full Page Pattern**: TreePreview component on variety page + dedicated TreePage
- **Sidebar Layout**: Match the map page design with left sidebar for controls and filters
- **Data Integration**: Adapt `src/18_generate_tree_data.py` to output data for the new structure
- **React Flow Integration**: Port existing tree visualization components
- **Consistent UX**: Maintain same navigation patterns as the map implementation

## ğŸ“ **Current State Analysis**

### **Existing grape-tree-react Structure**
```
grape-tree-react/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ App.jsx                    # Main React Flow app with variety dropdown
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ GrapeNode.jsx         # Custom React Flow node component
â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â””â”€â”€ tree-data.json        # Generated by src/18_generate_tree_data.py
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ treeUtils.js          # Tree manipulation utilities
â”œâ”€â”€ package.json                  # React Flow, reactflow dependencies
â””â”€â”€ vite.config.js               # Configured for /family-trees/ sub-path
```

### **Data Generation (src/18_generate_tree_data.py)**
- **Input**: `data/grape_variety_mapping.jsonl`
- **Output**: Unified tree data with nodes and edges for React Flow
- **Features**: Species coloring, country flags, duplicate parent handling
- **Data Structure**: 
  ```json
  {
    "varieties": ["Acadie Blanc", "Marquette", ...],
    "nodes": [...], // React Flow node format
    "edges": [...], // React Flow edge format
    "country_flags": {...}
  }
  ```

## ğŸ—ï¸ **Implementation Plan**

### **Phase 1: Component Architecture (Priority: HIGH)**

#### **1.1 Install Dependencies**
```bash
cd grape-explorer-react
npm install reactflow @reactflow/controls @reactflow/background
```

#### **1.2 Create TreePreview Component**
- **Location**: `src/components/TreePreviewReactFlow.jsx`
- **Purpose**: Static preview showing variety's immediate family (parents/children)
- **Design**: Rectangle container like MapPreview, but with **EXISTING tree visual style**
- **Click Action**: Navigate to `/tree?variety=Acadie%20Blanc`
- **Key Features**:
  - Show 3-5 nodes maximum (variety + immediate family)
  - **PRESERVE existing grape-tree-react node styling and colors**
  - Limited interactivity (preview only, click to launch full tree)

#### **1.3 Create TreePage Component**
- **Location**: `src/pages/TreePage.jsx`
- **Architecture**: **EXACTLY MATCH MapPage.jsx structure**
- **Layout**:
  ```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Header (inherited)                      â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ Left Sidebar â”‚ Tree Visualization       â”‚
  â”‚              â”‚                          â”‚
  â”‚ â€¢ Breadcrumb â”‚ React Flow Canvas        â”‚
  â”‚ â€¢ Title      â”‚                          â”‚
  â”‚ â€¢ Node Count â”‚ Interactive Tree         â”‚
  â”‚ â€¢ Filters:   â”‚                          â”‚
  â”‚   - Species  â”‚ Zoom/Pan Controls        â”‚
  â”‚   - Origin   â”‚                          â”‚
  â”‚ â€¢ Tree Mode: â”‚                          â”‚
  â”‚   - Standard â”‚                          â”‚
  â”‚   - Duplicateâ”‚                          â”‚
  â”‚ â€¢ Legend     â”‚                          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```

#### **1.4 Port GrapeNode Component**
- **Location**: `src/components/GrapeNode.jsx`
- **Source**: Copy from `grape-tree-react/src/components/GrapeNode.jsx`
- **Adaptations**:
  - **PRESERVE EXISTING STYLING** - Do not change the current tree appearance
  - Ensure flag-icons CSS compatibility
  - Keep existing hover states and visual design exactly as is

### **Phase 2: Data Integration (Priority: HIGH)**

#### **2.1 Copy Tree Data Generator**
- **Action**: Copy existing tree data to grape-explorer-react
```bash
cp grape-tree-react/src/data/tree-data.json grape-explorer-react/public/data/
```

#### **2.2 Update Data Generator (Optional Enhancement)**
- **File**: `src/18_generate_tree_data.py`
- **Changes**:
  - Add variety-specific subgraph extraction (like map data)
  - Pre-generate data for top 20 varieties
  - Output to both locations: `grape-tree-react/` AND `grape-explorer-react/public/data/`

### **Phase 3: Routing Integration (Priority: MEDIUM)**

#### **3.1 Add Tree Routes**
- **File**: `src/App.jsx`
- **Routes to Add**:
```jsx
<Route path="/tree" element={<TreePage />} />
<Route path="/variety/:slug/tree" element={<TreePage />} />
```

#### **3.2 Update TreePreview Navigation**
- **File**: `src/components/TreePreviewReactFlow.jsx`
- **Navigation**: Use `navigate('/tree?variety=' + variety.name)` (same as map)

#### **3.3 Update GrapeVarietyPage**
- **File**: `src/pages/GrapeVarietyPage.jsx`
- **Change**: Replace `<TreePreview>` with `<TreePreviewReactFlow>`

### **Phase 4: Styling & UX (Priority: MEDIUM)**

#### **4.1 Sidebar Styles**
- **File**: `src/index.css`
- **Pattern**: Copy `.map-sidebar` styles and adapt for tree-specific content
- **Sections**:
  - `.tree-sidebar`
  - `.tree-filters`
  - `.tree-legend`
  - `.tree-content`

#### **4.2 Tree-Specific Controls**
- **Species Filter**: Dropdown for Vitis vinifera, hybrids, etc.
- **Origin Filter**: Country/region filtering
- **Tree Mode Toggle**: Standard vs. Duplicate Parents view
- **Node Count Display**: Show total nodes in current view

#### **4.3 Mobile Responsiveness**
- **Pattern**: Follow map mobile layout (tree on top 60vh, sidebar below 40vh)

### **Phase 5: Advanced Features (Priority: LOW)**

#### **5.1 Tree Utilities**
- **File**: `src/utils/treeUtils.js`
- **Functions**: Copy from grape-tree-react for subgraph extraction, layout algorithms

#### **5.2 Performance Optimizations**
- **Lazy Loading**: Load tree data only when needed
- **Viewport Optimization**: React Flow viewport management
- **Node Virtualization**: For large trees

## ğŸ”§ **Technical Specifications**

### **Key Files to Create/Modify**

```
grape-explorer-react/src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ TreePreviewReactFlow.jsx     [NEW] - Static tree preview
â”‚   â””â”€â”€ GrapeNode.jsx                [NEW] - React Flow node component
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ TreePage.jsx                 [NEW] - Full tree page (copy MapPage pattern)
â”‚   â””â”€â”€ GrapeVarietyPage.jsx         [MODIFY] - Use new TreePreview
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ treeUtils.js                 [NEW] - Tree manipulation utilities
â”œâ”€â”€ App.jsx                          [MODIFY] - Add tree routes
â””â”€â”€ index.css                        [MODIFY] - Add tree sidebar styles

public/data/
â””â”€â”€ tree-data.json                   [COPY] - Tree data for React Flow
```

### **Data Flow Pattern** (Match Map Implementation)
```
1. TreePreview loads variety-specific subgraph
2. Click preview â†’ navigate to TreePage with variety parameter
3. TreePage loads full tree data, applies filters
4. Sidebar controls tree visualization state
5. Browser back button returns to variety page
```

### **Navigation Pattern** (Match Map Implementation)
```
/variety/acadie-blanc (main page)
  â†“ click tree preview
/tree?variety=Acadie%20Blanc (full tree page)
  â†“ breadcrumb click "Acadie Blanc" 
/variety/acadie-blanc (back to main page)
```

## ğŸ“Š **Dependencies & Installation**

### **Required Packages**
```json
{
  "reactflow": "^11.10.1",
  "@reactflow/controls": "^11.2.1", 
  "@reactflow/background": "^11.3.1"
}
```

### **Optional Enhancements**
- `flag-icons` CSS library (already used in tree data)
- Custom React Flow plugins for grape-specific layouts

## ğŸ¨ **Design Consistency Requirements**

### **Match Established Patterns**
1. **Sidebar Width**: 320px (same as map)
2. **Color Scheme**: Blue primary (#007bff), existing grape-explorer colors
3. **Typography**: System fonts, same hierarchy as map page
4. **Mobile Breakpoint**: 768px (same as map)
5. **Navigation**: Same breadcrumb and back button patterns

### **Tree-Specific Design Elements**
1. **Node Styling**: **PRESERVE EXISTING** - Keep current grape-tree-react node design exactly as is
2. **Edge Styling**: **PRESERVE EXISTING** - Keep current connecting line styles
3. **Species Colors**: **PRESERVE EXISTING** - Keep current color coding from grape-tree-react
4. **Hover States**: **PRESERVE EXISTING** - Keep current hover interactions exactly as they are

## âœ… **Success Criteria**
- [ ] TreePreview shows on Acadie Blanc variety page
- [ ] Click preview navigates to full tree page
- [ ] Tree page matches map page layout exactly (sidebar + main content)
- [ ] All navigation (back button, breadcrumbs) works correctly
- [ ] Mobile layout stacks properly (tree top, sidebar bottom)
- [ ] Species and origin filters work correctly
- [ ] Tree mode toggle switches between standard/duplicate views
- [ ] Performance is acceptable for trees with 50+ nodes

## ğŸš¨ **Critical Implementation Notes**

### **Copy MapPage Architecture EXACTLY**
The tree implementation should be nearly identical to the map implementation:
- Same component structure in TreePage.jsx
- Same CSS class patterns (.tree-* instead of .map-*) **BUT only for sidebar/layout**
- Same mobile responsive behavior
- Same navigation and URL handling patterns

### **PRESERVE EXISTING TREE VISUAL DESIGN**
- **DO NOT change node styling, colors, or visual appearance**
- **DO NOT change edge/connection styling**
- **DO NOT change hover states or interactions within the tree**
- **ONLY adapt the container layout and sidebar controls**

### **Data Loading Pattern**
Follow the map pattern exactly:
```jsx
// In TreePage.jsx - match MapPage.jsx structure
const [treeData, setTreeData] = useState(null)
const [allNodes, setAllNodes] = useState([])
const [filteredNodes, setFilteredNodes] = useState([])
const currentVariety = variety || searchParams.get('variety')

useEffect(() => {
  const loadTreeData = async () => {
    const response = await fetch('/data/tree-data.json')
    const data = await response.json()
    // Apply variety-specific filtering like map does
  }
}, [currentVariety])
```

### **URL and Navigation**
Use exact same pattern as map:
- TreePreview: `navigate('/tree?variety=' + encodeURIComponent(variety.name))`
- Back navigation: Handle variety slug conversion same as MapPage
- Browser history: Use React Router navigate() not window.location

This plan ensures the tree integration will be architecturally consistent with the successful map implementation while leveraging the existing React Flow tree visualization components.